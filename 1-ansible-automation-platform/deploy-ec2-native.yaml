---
- name: Create a rhel aws ec2 instance
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:

    - name: Retrieve the default vpc subnet id
      ec2_vpc_subnet_info:
        region: "{{ region.split(' ')[0] | default('ap-southeast-2') }}"
        filters:
          "tag:Name": "rhel-demo-dev-public-subnet"
      register: subnet_info

    - debug:
        msg:
          - "Subnet identified: {{ subnet_info.subnets[0].id }}"
          - "Region input: {{ region }}"
          - "Instance type: {{ instance_type }}"
          - "Purpose: {{ tags_purpose }}"

    - name: Create a rhel aws ec2 instance
      amazon.aws.ec2_instance:
        name: "{{ tags_purpose }}-ec2-instance"
        key_name: "rhel-demo-dev-linux-ap-southeast-2"
        vpc_subnet_id: "{{ subnet_info.subnets[0].id }}"
        instance_type: "{{ instance_type.split(' ')[0] | default('t2.micro') }}"
        security_group: "rhel-demo-dev-linux-sg"
        region: "{{ region.split(' ')[0] | default('ap-southeast-2') }}"
        network:
          assign_public_ip: false
        image_id: "ami-0b4ee18dc73d90a7b"
        user_data: "{{ lookup_file('file', '../0-deploy-demo-infra/aws-user-data.sh') | b64encode }}"
        wait: true
        tags:
          type: "demo"
          purpose: "{{ tags_purpose }}"
