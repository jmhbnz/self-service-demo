 - name: "Execute terraform plan"
   hosts: localhost
   connection: local

   tasks:

     - name: "Define the backend configuration at init"
       community.general.terraform:
         project_path: "../2-vm-cloud-migration/"
         state: "planned"
         force_init: true
         plan_file: "testing"
         variables:
           aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
           aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
           TF_HTTP_ADDRESS: https://gitlab.com/api/v4/projects/40640695/terraform/state/aws-rhel-ec2
           TF_HTTP_LOCK_ADDRESS: https://gitlab.com/api/v4/projects/40640695/terraform/state/aws-rhel-ec2/lock
           TF_HTTP_UNLOCK_ADDRESS: TF_HTTP_UNLOCK_ADDRESS
           TF_HTTP_LOCK_METHODD: POST
           TF_HTTP_UNLOCK_METHOD: DELETE
           TF_USERNAME: "{{ TF_USERNAME }}"
           TF_PASSWORD: "{{ TF_PASSWORD }}"
       register: plan

     - name: "Output terraform plan"
       debug:
         msg: "{{ plan }}"
